datatab    equ 0xc100

fadein:

1:      halt                  ; avoid conflicts with interrupt
        ld      a,(delframe)
        cp      animdealay
        jr      nz,1b

        exx
        ld      d,0
        ld      e,b
        ld      hl,colorfading-1
        add     hl,de
        ld      a,(hl)
        ex      af,af
        exx


        xor     a
        out     (0x99),a
        ld      a,0x2000/256 + 0x40 ; PCT
        out     (0x99),a


        ld      hl,0xc000+3*256*8
        ld      bc,256*8*2

loopfadein:

        xor     a
        rld
        ld      e,a
        rld
        ld      d,a
        rld

        ld      a,e
        cp  15

        jp      nz,1f

        ex      af,af
        ld      e,a
        ex      af,af
1:
        ld      a,d
        cp  15

        jp      nz,1f

        ex      af,af
        ld      d,a
        ex      af,af

1:
        ld      a,e
        rept    4
        add     a,a
        endm
        or      d
        out     (0x98),a

        inc     hl

        dec     bc
        ld      a,b
        or      c
        jp      nz,loopfadein
        ret



