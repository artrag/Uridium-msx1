001   0000             CHGMOD:      equ    #005F
002   0000             LDIRMV:      equ    #0059
003   0000             CALSLT:      EQU    #001C
004   0000             EXPTBL:      EQU    #FCC1
005   0000             
006   0000             ntiles:     equ     256
007   0000             
008   0000             
009   0000                     
010   0000                     OUTPUT vplayer.rom
011   0000             		org	4000h
012   4000             		dw	"BA",START,0,0,0
012   4000 41424340000000000000
013   400A                     
014   400A             
015   400A             ;-------------------------------------
016   400A             ; Instead of CHGMOD
017   400A             ;-------------------------------------
018   400A             
019   400A             _vdpinit:
020   400A F3                      di
021   400B 21 1D 40                ld hl,_vdpregs
022   400E 01 99 80                ld bc,0x8099
023   4011 ED A3       1:          outi
024   4013 04                      inc b
025   4014 ED 41                   out (c),b
026   4016 04                      inc b
027   4017 CB 58                   bit 3,b
028   4019 28 F6                   jr z,1b
029   401B             
030   401B FB                      ei
031   401C C9                      ret
032   401D             
033   401D             _vdpregs:
034   401D 02                    defb 0x02 ; Reg# 0 000000[M3][EV]
035   401E 62                    defb 0x62 ; Reg# 1 [4/16k][BLANK][IE][M1][M2]0[SIZE][MAG]
036   401F 06                    defb 0x06 ; Reg# 2 0000[NAME TABLE BASE ADDRESS]          = 1800h
037   4020 FF                    defb 0xFF ; Reg# 3 [COLOR BASE ADDRESS]                   = 2000h ; regular mode for colors
038   4021 03                    defb 0x03 ; Reg# 4 00000[PATTERN GENERATOR BASE ADDRESS]  = 0000h  ; regular mode for patterns
039   4022                       
040   4022 36                    defb 0x36 ; Reg# 5 0[SPRITE ATTRIBUTE TABLE BASE ADDRESS] = 1b00h
041   4023 07                    defb 0x07 ; Reg# 6 00000[SPRITE PTRN GNRTR BASE ADDRESS]  = 3800h
042   4024 01                    defb 0x01 ; Reg# 7 [TEXT COLOR 4bts][BACKDROP COLOR 4bts]
043   4025             
044   4025             
045   4025             ;-------------------------------------
046   4025             ; set pages and subslot
047   4025             ;-------------------------------------
048   4025             ;
049   4025             powerup:
050   4025             
051   4025 CD 38 01            call    0x138
052   4028 0F                  rrca
053   4029 0F                  rrca
054   402A E6 03               and     0x03
055   402C 4F                  ld      c,a
056   402D 06 00               ld      b,0
057   402F 21 C1 FC            ld      hl,EXPTBL
058   4032 09                  add     hl,bc
059   4033 B6                  or      (hl)
060   4034 47                  ld      b,a
061   4035 23                  inc     hl
062   4036 23                  inc     hl
063   4037 23                  inc     hl
064   4038 23                  inc     hl
065   4039 7E                  ld      a,(hl)
066   403A E6 0C               and     0x0c
067   403C B0                  or      b
068   403D                     
069   403D 26 80               ld      h,0x80
070   403F CD 24 00            call    0x24        
071   4042                 
072   4042 C9                  ret
073   4043             
074   4043             ;-------------------------------------
075   4043             ; Entry point
076   4043             ;-------------------------------------       
077   4043             START:
078   4043 CD 25 40            call    powerup
079   4046                     
080   4046 CD 55 40            call    RESET_VDP
081   4049                     
082   4049             
083   4049             .REWIND:
084   4049             
085   4049 1E 0E               ld      e,nf
086   404B D9                  exx                
087   404C             
088   404C 21 9A 5A            ld      hl, SAMPLE_START
089   404F             
090   404F CD AE 40            call    PLAY_SAMPLE
091   4052                     
092   4052 18 F5               jr      .REWIND
093   4054 C9                  ret
094   4055                     
095   4055                     
096   4055             
097   4055             ;-------------------------------------
098   4055             ; Resets the vdp
099   4055             ;-------------------------------------
100   4055             
101   4055             RESET_VDP:
102   4055             
103   4055 CD 0A 40            call    _vdpinit
104   4058             
105   4058 21 AA 41            ld      hl,patandcol
106   405B 11 00 C0            ld      de,0xc000
107   405E CD F9 40            call    mom_depack_rom
108   4061 CD F9 40            call    mom_depack_rom        
109   4064                     
110   4064 21 00 C0            ld      hl,0xc000;  patterns and colors
111   4067             
112   4067 AF                  xor     a
113   4068 D3 99               out     (0x99),a
114   406A 3E 40               ld      a,0x0000/256 + 0x40 ; PGT
115   406C D3 99               out     (0x99),a
116   406E             
117   406E CD A0 40            call    outs         
118   4071             
119   4071 AF                  xor     a
120   4072 D3 99               out     (0x99),a
121   4074 3E 48               ld      a,0x0800/256 + 0x40 ; PGT
122   4076 D3 99               out     (0x99),a
123   4078             
124   4078 CD A0 40            call    outs
125   407B                     
126   407B AF                  xor     a
127   407C D3 99               out     (0x99),a
128   407E 3E 50               ld      a,0x1000/256 + 0x40 ; PGT
129   4080 D3 99               out     (0x99),a
130   4082                 
131   4082 CD A0 40            call    outs
132   4085                     
133   4085 AF                  xor     a
134   4086 D3 99               out     (0x99),a
135   4088 3E 60               ld      a,0x2000/256 + 0x40 ; PCT
136   408A D3 99               out     (0x99),a
137   408C                     
138   408C CD A0 40            call    outs
139   408F                     
140   408F AF                  xor     a
141   4090 D3 99               out     (0x99),a
142   4092 3E 68               ld      a,0x2800/256 + 0x40 ; PCT
143   4094 D3 99               out     (0x99),a
144   4096             
145   4096 CD A0 40            call    outs
146   4099             
147   4099 AF                  xor     a
148   409A D3 99               out     (0x99),a
149   409C 3E 70               ld      a,0x3000/256 + 0x40 ; PCT
150   409E D3 99               out     (0x99),a
151   40A0                     
152   40A0             outs:
153   40A0                     
154   40A0 11 00 08            ld      de,ntiles*8
155   40A3 0E 98               ld      c,0x98
156   40A5                      
157   40A5 ED A3       1:      outi
158   40A7 1D                  dec e
159   40A8 20 FB               jr nz,1b
160   40AA 15                  dec d
161   40AB 20 F8               jr nz,1b
162   40AD                      
163   40AD C9                  ret         
164   40AE             
165   40AE             ;-------------------------------------
166   40AE             ; replayer core
167   40AE             ;-------------------------------------
168   40AE             
169   40AE             PLAY_SAMPLE:
170   40AE             
171   40AE 11 00 C0            ld      de,0xc000      ; destination
172   40B1 CD F9 40            call    mom_depack_rom
173   40B4                     
174   40B4             
175   40B4 CD E2 40            call    setframe
176   40B7                     
177   40B7 D9                  exx
178   40B8 1D                  dec e                       ; first keyframe extracted 
179   40B9 D9                  exx
180   40BA                     
181   40BA             2:
182   40BA 11 00 C4            ld      de,0xc000+1024      ; destination
183   40BD CD F9 40            call    mom_depack_rom
184   40C0             
185   40C0 E5                  push    hl
186   40C1                     
187   40C1 21 00 C0            ld      hl,0xc000
188   40C4 11 00 C4            ld      de,0xc000+1024
189   40C7 01 00 03            ld      bc,768
190   40CA 1A          1:      ld      a,(de)
191   40CB 86                  add     a,(hl)
192   40CC 77                  ld      (hl),a
193   40CD 23                  inc     hl
194   40CE 13                  inc     de
195   40CF 0D                  dec     c
196   40D0 C2 CA 40            jp      nz,1b
197   40D3 05                  dec     b
198   40D4 C2 CA 40            jp      nz,1b
199   40D7             
200   40D7 E1                  pop     hl                   ; full frame rebuilt
201   40D8             
202   40D8 CD E2 40            call    setframe
203   40DB                     
204   40DB D9                  exx
205   40DC 1D                  dec e
206   40DD D9                  exx
207   40DE                             
208   40DE C2 BA 40            jp     nz,2b               ; last frame
209   40E1                           
210   40E1 C9                  ret
211   40E2             
212   40E2             setframe:
213   40E2 E5                  push    hl        
214   40E3 76                  halt
215   40E4 AF                  xor a
216   40E5 D3 99               out     (0X99),a
217   40E7 3E 58               ld      a,0x18 + 64
218   40E9 D3 99               out     (0X99),a       
219   40EB 01 98 00            ld      bc,0X98
220   40EE 21 00 C0            ld      hl,0xc000           ; plot a 768 bytes frame from here
221   40F1 ED B3               otir                                  
222   40F3 ED B3               otir                                  
223   40F5 ED B3               otir                                          
224   40F7 E1                  pop     hl
225   40F8 C9                  ret
226   40F9             
227   40F9             ; -------------------------------------------------------
228   40F9             ; MSX-O-Mizer v1.5f datas depacker    *ROM based version*
229   40F9             ; Improved from Metalbrain's z80 version.
230   40F9             ; -------------------------------------------------------
231   40F9             ; source in hl
232   40F9             ; dest in de
233   40F9             
234   40F9             ; 328 bytes which must be aligned on 8 bits boundary
235   40F9             mom_map_bits_rom    =       0xF100
236   40F9             ; 26 bytes located in ram
237   40F9             mom_offset_table    =       0xF100 + 328
238   40F9             
239   40F9 D5          mom_depack_rom:     push    de
240   40FA 01 48 F2                        ld      bc, mom_offset_table
241   40FD C5                              push    bc
242   40FE 50 59                           ld      de, bc
243   4100 01 1A 00                        ld      bc, 26
244   4103 ED B0                           ldir
245   4105 E5                              push    hl
246   4106 F1                              pop     af
247   4107 E1                              pop     hl
248   4108 F5                              push    af
249   4109 FD 21 F0 F1                     ld      iy, mom_map_bits_rom + 0xf0
250   410D 06 34                           ld      b, 52
251   410F FD 7D       mom_init_bits_rom:  ld      a, iyl
252   4111 E6 0F                           and     15
253   4113 20 03                           jr      nz, mom_node_rom
254   4115 11 01 00                        ld      de, 1
255   4118 ED 67       mom_node_rom:       rrd
256   411A FD 77 00                        ld      (iy), a
257   411D FD 73 24                        ld      (iy + 36), e
258   4120 FD 72 48                        ld      (iy + 72), d
259   4123 FD 2C                           inc     iyl
260   4125 3C                              inc     a
261   4126 E5                              push    hl
262   4127 21 00 00                        ld      hl, 0
263   412A 37                              scf
264   412B ED 6A       mom_set_bit_rom:    adc     hl, hl
265   412D 3D                              dec     a
266   412E 20 FB                           jr      nz, mom_set_bit_rom
267   4130 19                              add     hl, de
268   4131 EB                              ex      de, hl
269   4132 E1                              pop     hl
270   4133 CB 40                           bit     0, b
271   4135 28 01                           jr      z, mom_wait_step_rom
272   4137 23                              inc     hl
273   4138 10 D5       mom_wait_step_rom:  djnz    mom_init_bits_rom
274   413A E1                              pop     hl
275   413B 7E                              ld      a, (hl)
276   413C 23                              inc     hl
277   413D DD 67                           ld      ixh, a
278   413F D1                              pop     de
279   4140 ED A0       mom_lit_copy_rom:   ldi
280   4142 CD 9F 41    mom_main_loop_rom:  call    mom_get_bit_rom
281   4145 38 F9                           jr      c, mom_lit_copy_rom
282   4147 0E EF                           ld      c, -17
283   4149 CD 9F 41    mom_get_index_rom:  call    mom_get_bit_rom
284   414C 0C                              inc     c
285   414D 30 FA                           jr      nc, mom_get_index_rom
286   414F 79                              ld      a, c
287   4150 C8                              ret     z
288   4151 D5                              push    de
289   4152 CD 7E 41                        call    mom_get_pair_rom
290   4155 C5                              push    bc
291   4156 20 0C                           jr      nz, mom_out_range_rom
292   4158 11 20 02                        ld      de, 0x0220
293   415B 0D                              dec     c
294   415C 28 09                           jr      z, mom_go_for_it_rom
295   415E 11 10 04                        ld      de, 0x0410
296   4161 0D                              dec     c
297   4162 28 03                           jr      z, mom_go_for_it_rom
298   4164 11 00 04    mom_out_range_rom:  ld      de, 0x0400
299   4167 F1          mom_go_for_it_rom:  pop     af
300   4168 08                              ex      af, af'
301   4169 CD 90 41                        call    mom_get_bits_rom
302   416C 83                              add     a, e
303   416D CD 7E 41                        call    mom_get_pair_rom
304   4170 D1                              pop     de
305   4171 E5                              push    hl
306   4172 62                              ld      h, d
307   4173 6B                              ld      l, e
308   4174 ED 42                           sbc     hl, bc
309   4176 08                              ex      af, af'
310   4177 F5                              push    af
311   4178 C1                              pop     bc
312   4179 ED B0                           ldir
313   417B E1                              pop     hl
314   417C 18 C4                           jr      mom_main_loop_rom
315   417E FD 6F       mom_get_pair_rom:   ld      iyl, a
316   4180 FD 56 00                        ld      d, (iy)
317   4183 CD 90 41                        call    mom_get_bits_rom
318   4186 FD 86 24                        add     (iy + 36)
319   4189 4F                              ld      c, a
320   418A 78                              ld      a, b
321   418B FD 8E 48                        adc     (iy + 72)
322   418E 47                              ld      b, a
323   418F C9                              ret
324   4190 01 00 00    mom_get_bits_rom:   ld      bc, 0
325   4193             mom_getting_bits_rom:
326   4193 15                              dec     d
327   4194 79                              ld      a, c
328   4195 F8                              ret     m
329   4196 CD 9F 41                        call    mom_get_bit_rom
330   4199 CB 11                           rl      c
331   419B CB 10                           rl      b
332   419D 18 F4                           jr      mom_getting_bits_rom
333   419F DD 7C       mom_get_bit_rom:    ld      a, ixh
334   41A1 87                              add     a
335   41A2 20 03                           jr      nz, mom_byte_done_rom
336   41A4 7E                              ld      a, (hl)
337   41A5 23                              inc     hl
338   41A6 17                              rla
339   41A7 DD 67       mom_byte_done_rom:  ld      ixh, a
340   41A9 C9                              ret
341   41AA             
342   41AA             ;-------------------------------------
343   41AA             ; tile data
344   41AA             ;-------------------------------------
345   41AA             
346   41AA             patandcol:  incbin tiles.pat.bin.miz
347   5555                         incbin tiles.col.bin.miz
348   5A9A             
349   5A9A             ;-------------------------------------
350   5A9A             ; Sample data
351   5A9A             ;-------------------------------------
352   5A9A             SAMPLE_START:
353   5A9A             
354   5A9A             
355   5A9A                     include romdatadeltapack.asm
001+  5A9A             nf equ  14
002+  5A9A              incbin frames_bin\pic1.png.bin.d.dmiz
003+  5D9E              incbin frames_bin\pic2.png.bin.d.dmiz
004+  60D2              incbin frames_bin\pic3.png.bin.d.dmiz
005+  6411              incbin frames_bin\pic4.png.bin.d.dmiz
006+  6753              incbin frames_bin\pic5.png.bin.d.dmiz
007+  6AA8              incbin frames_bin\pic6.png.bin.d.dmiz
008+  6E02              incbin frames_bin\pic7.png.bin.d.dmiz
009+  7148              incbin frames_bin\pic8.png.bin.d.dmiz
010+  7489              incbin frames_bin\pic9.png.bin.d.dmiz
011+  77DA              incbin frames_bin\picA.png.bin.d.dmiz
012+  7B1B              incbin frames_bin\picB.png.bin.d.dmiz
013+  7E60              incbin frames_bin\picC.png.bin.d.dmiz
014+  81A7              incbin frames_bin\picD.png.bin.d.dmiz
015+  84F9              incbin frames_bin\picE.png.bin.d.dmiz
356   8836                     
357   8836             
358   8836             SAMPLE_END:
359   8836             
360   8836             
361   8836             
362   8836             FINISH:
363   8836             
364   8836             
365   8836             
366   8836             
367   8836             
368   8836             
369   8836             
370   8836             
371   8836             
372   8836             
373   8836             
374   8836             
375   8836             
